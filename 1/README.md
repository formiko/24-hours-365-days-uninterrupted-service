# 第1章 服务器基础设施搭建入门-冗余及负载分流的基础
## 1.1 冗余的基础
### 1.1.1 冗余概述
### 1.1.2 冗余的本质
1. 设想可能发生的故障
2. 预先准备好备份设备
3. 部署工作机制——当故障发生时，切换到备份设备
### 1.1.3 应对路由器故障的情况
冷备份：只有在故障发生时才需要连接到备份设备
### 1.1.4 应对Web服务器故障的情况
热备份：多台服务器同时运行，并保持同样状态的使用模式。
### 1.1.5 故障转移
* 故障转移：当现用设备发生故障时，系统会自动将处理交接到备份设备。
#### VIP
* VIP：虚拟IP地址（Virtual IP Address）
#### IP地址的映射
### 1.1.6 检测故障——健康检查
* 根据用途选择合适的方法：
    * ICMP监控（第三层）
        检查由ICMP所发出的echo请求是否得到了应答。由于这是最基本的健康检查，因此无法得知Web服务（Apache等）是否已经停止
    * 端口监控（第四层）
        通过使用TCP协议尝试连接主机，检查目标主机是否能被连接。该监控可以得知Web服务是否还在正常运行，但无从得知系统的负载情况，也无从得知错误的回报情况
    * 服务监控（第七层）
        通过实际发出HTTP请求等，检查该请求是否得到了应答。虽说这种方法可以检查所有的异常状况，但根据情况的不同，可能会加重目标主机的负载
* Web服务器的健康检查
    用的服务监控（第七层）
* 路由器的健康检查
    用的ICMP监控（第三层）
### 1.1.7 搭建Active/Backup的拓扑结构
### 1.1.8 还想更有效地使用服务器——负载分发
## 1.2 实现Web服务器的冗余——DNS轮询
### 1.2.1 DNS轮询
* DNS轮询是指：利用DNS把一台服务器需要处理的内容，分配到多台服务器来进行。
* DNS轮询存在以下问题：
    * 必须取得需要轮询的所有目标服务器的IP地址
    * 并不一定能实现均等的分发
        * 来自手机的访问会经由称为行业网关的代理服务器，代理服务器会将域名解析的结果缓存一段时间，所有经由代理服务器的访问请求就会被解析到同一台服务器上。
        * PC平台上的网页浏览器也会缓存DNS解析的结果。
        * 虽说将DNS记录的TTL（Time To Live，DNS记录的缓存时间）修改得短一些多少可以改善这个问题，但不能根本解决问题（困惑，为什么不能根本解决）
    * 无从得知服务器宕机
        即便服务器宕机，仍然继续进行负载分发处理
### 1.2.2 DNS轮询的冗余拓扑结构示例
### 1.2.3 还想更轻松地扩充系统——负载均衡器
## 1.3 实现Web服务器的冗余——基于IPVS的负载均衡器
### 1.3.1 DNS轮询与负载均衡器的不同点
* 负载均衡器（Load Balancer，也称负载分发或负载分流设备）能够将向同一IP地址发出的请求分发到多台服务器进行处理。而DNS轮询则需要分别向Web服务器分配不同的IP地址（全局地址）。因此使用负载均衡器，能够节省全局地址的使用。
* 负载均衡器的行为
    被作为虚拟服务器使用，拥有提供服务的全局地址，就像是Web服务器一样运行
* 负载均衡器的功能
    负载均衡器一定会选择健康检查成功的服务器。因此只要有一台服务器正常工作，都不会影响到整个服务的正常提供。
* 引入负载均衡器的门槛
    人们觉得贵和难
### 1.3.2 IPVS——基于Linux的负载均衡器
* 即使不安装特别的软件，Linux也可以作为路由器（或其他网络设备）使用。而且系统的防火墙也有很多实用的功能，例如分组过滤（Packet Filtering）技术等众多的网络功能。提供负载均衡的IPVS（IP Virtual Server）模块也包含在其中。
* 负载均衡器的种类与IPVS的功能
    * 按大的方向分为四层交换机（L4 Switch）与七层交换机（L7 Switch）两种。
    * 四层交换机进行的传输层信息的处理，可以根据IP地址和端口号，指定作为分发目的地的服务器。
    * 七层交换机进行的则是应用层信息的处理，可以根据客户端请求URL，指定分发目的地的目标服务器。
    * 安装了IPVS就“相当于拥有了四层交换机的功能”。
    * 本书主要讲四层交换机的负载均衡器。
### 1.3.3 调度算法
* 主要的算法：
    * rr（round-robin，轮询）调度
    * wrr（weighted round-robin，加权轮询）调度
    * lc（least-connection，最小连接）调度
    * wlc（weighted least-connection，加权最小连接）调度
    * sed（shortest expected delay，最短预期延时）调度
        其行为基本上和上述的wlc一样，但wlc会把除ESTABLISHED以外的状态（TIME_WAIT或FIN_WAIT等）的连接数计算在最小因数中。
    * nq（never queue，不排队）调度
        优先选择活动连接数为0的服务器
* 其他的调度算法
    * sh（source hashing，源地址散列）调度
    * dh（destination hashing，目标地址散列）调度
    * lblc（locality-based least-connection，基于局部性的最小连接）调度
        在连接数没有超过加权值指定的值时，将选择同一台服务器。若是超过了，则选择其他的服务器。当所有服务器的连接数都超过加权值指定的值时，将选择最终所选的那台服务器）
    * lblcr（locality-based least-connection with replication，带复制的基于局部性最小连接）调度
        与上述lblc有些类似，区别是当所有服务器的连接数都超过加权值指定值时，将选择连接数最少的那台服务器。
### 1.3.4 使用IPVS
#### ipvsadm
* IPVS开发商提供的命令行工具。地位相当于netfilter组件与iptables命令之间的关系。
#### keepalived
* 用C语言编写的守护程序
* 可以根据配置文件（/etc/keppalived/keepalived.conf）的内容来搭建IPVS的虚拟主机。
* 功能：对真实服务器进行健康检查，并自动将已经宕机的服务器排除在负载均衡所分配的范围外；如果所有的真实服务器全数宕机，则会显示“服务器繁忙”等消息，即具备sorry_server功能。
* 截至2014年11月，keepalived-1.2.13支持以下健康检查：
    * HTTP_GET
    * SSL_GET
    * TCP_CHECK
    * SMTP_CHECK
    * MISC_CHECK：通过执行外部命令所返回结束代码来确认目标服务器的健康状况
### 1.3.5 搭建负载均衡器
#### 配置keepalived
#### 配置Web服务器
#### 启动keepalived
#### 确认负载分流
#### 确认冗余的拓扑结构
### 1.3.6 四层交换机与七层交换机
* 不同点：四层交换机中，客户端（Web浏览器）的通信目标是真实服务器。而在七层交换机中，负载均衡器和客户端会先通过TCP会话进行握手。
* 追求设定的灵活性就用七层交换机
* 追求性能就用四层交换机
### 1.3.7 四层交换机的NAT模型与DSR模型
* NAT（Network Address Translation，网络地址转换）模型，为了追求更高的性能，也可以搭建DSR（Direct Server Return，直接服务器返回）模型。
* （困惑）DNAT（Destination Network Address Translation，目的网络地址转换）。
### 1.3.8 同一子网下的服务器进行负载分流时需要注意的地方
* 在同一子网需要负载分流时，不能使用NAT模型。
    因为源地址与目的地址是同一子网下的IP地址，因此不会将分组发往负载均衡器，而直接从源地址发送到Web服务器。因此该NAT模型中源地址的IP地址尚未被正确转发到目标服务器，进而就造成了不能正确完成通信
* 同一子网下的负载分流，使用DSR模型较好，因为DSR模型不用映射负载均衡器的IP地址。
 